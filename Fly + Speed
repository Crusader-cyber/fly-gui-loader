local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- // CONFIGURATION // --
local FLIGHT_SPEED = 50
local FLIGHT_ACCEL = 4

-- // 1. GUI GENERATION (Instance.new) // --
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MasterControlGUI"
ScreenGui.ResetOnSpawn = false -- GUI stays when you die
ScreenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Background Panel
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 220, 0, 180)
MainFrame.Position = UDim2.new(0, 20, 0.5, -90) -- Left side of screen
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 10)
UICorner.Parent = MainFrame

-- Header Label
local Header = Instance.new("TextLabel")
Header.Text = "ADMIN TOOLS"
Header.Size = UDim2.new(1, 0, 0, 30)
Header.BackgroundTransparency = 1
Header.TextColor3 = Color3.fromRGB(255, 255, 255)
Header.Font = Enum.Font.GothamBlack
Header.TextSize = 16
Header.Parent = MainFrame

-- [FLY BUTTON]
local FlyBtn = Instance.new("TextButton")
FlyBtn.Name = "FlyButton"
FlyBtn.Size = UDim2.new(0, 200, 0, 45)
FlyBtn.Position = UDim2.new(0, 10, 0, 40)
FlyBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
FlyBtn.Text = "FLY MODE: OFF"
FlyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
FlyBtn.Font = Enum.Font.GothamBold
FlyBtn.TextSize = 14
FlyBtn.Parent = MainFrame

local FlyCorner = Instance.new("UICorner")
FlyCorner.Parent = FlyBtn

-- [SPEED SECTION LABELS]
local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Text = "Adjust WalkSpeed (16-100)"
SpeedLabel.Size = UDim2.new(1, 0, 0, 20)
SpeedLabel.Position = UDim2.new(0, 0, 0, 100)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
SpeedLabel.Font = Enum.Font.Gotham
SpeedLabel.TextSize = 12
SpeedLabel.Parent = MainFrame

-- [SPEED INPUT BOX]
local SpeedInput = Instance.new("TextBox")
SpeedInput.Name = "SpeedInput"
SpeedInput.Size = UDim2.new(0, 120, 0, 35)
SpeedInput.Position = UDim2.new(0, 10, 0, 125)
SpeedInput.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
SpeedInput.Text = "16"
SpeedInput.TextColor3 = Color3.fromRGB(0, 0, 0)
SpeedInput.Font = Enum.Font.GothamBold
SpeedInput.TextSize = 16
SpeedInput.Parent = MainFrame

local SpeedCorner = Instance.new("UICorner")
SpeedCorner.Parent = SpeedInput

-- [SET SPEED BUTTON]
local SetSpeedBtn = Instance.new("TextButton")
SetSpeedBtn.Name = "SetSpeedBtn"
SetSpeedBtn.Size = UDim2.new(0, 70, 0, 35)
SetSpeedBtn.Position = UDim2.new(0, 140, 0, 125)
SetSpeedBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255) -- Bright Blue
SetSpeedBtn.Text = "SET"
SetSpeedBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
SetSpeedBtn.Font = Enum.Font.GothamBold
SetSpeedBtn.TextSize = 14
SetSpeedBtn.Parent = MainFrame

local SetCorner = Instance.new("UICorner")
SetCorner.Parent = SetSpeedBtn

-- // 2. LOGIC VARIABLES // --
local flying = false
local bv, bg = nil, nil
local currentSpeed = 16
local controls = {W=0, S=0, A=0, D=0, Q=0, E=0}

-- // 3. FLIGHT FUNCTIONS // --

-- Track Key Presses
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.W then controls.W = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.S then controls.S = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.A then controls.A = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.D then controls.D = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.E then controls.E = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.Q then controls.Q = FLIGHT_SPEED end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.KeyCode == Enum.KeyCode.W then controls.W = 0 end
	if input.KeyCode == Enum.KeyCode.S then controls.S = 0 end
	if input.KeyCode == Enum.KeyCode.A then controls.A = 0 end
	if input.KeyCode == Enum.KeyCode.D then controls.D = 0 end
	if input.KeyCode == Enum.KeyCode.E then controls.E = 0 end
	if input.KeyCode == Enum.KeyCode.Q then controls.Q = 0 end
end)

local function stopFlying()
	flying = false
	-- Remove physics movers
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
	
	-- Reset humanoid state
	local char = player.Character
	if char then
		local hum = char:FindFirstChild("Humanoid")
		if hum then hum.PlatformStand = false end
	end
	
	-- Update Button Look
	FlyBtn.Text = "FLY MODE: OFF"
	FlyBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
end

local function startFlying()
	local char = player.Character
	if not char then return end
	local root = char:WaitForChild("HumanoidRootPart")
	local hum = char:WaitForChild("Humanoid")

	-- Create Physics
	bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
	bv.Velocity = Vector3.new(0,0,0)
	bv.Parent = root

	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
	bg.P = 10000 
	bg.D = 100
	bg.CFrame = root.CFrame
	bg.Parent = root

	hum.PlatformStand = true
	flying = true
	
	-- Update Button Look
	FlyBtn.Text = "FLY MODE: ON"
	FlyBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0) -- Green

	-- The Flight Loop
	task.spawn(function()
		while flying and char and hum.Health > 0 do
			local dt = RunService.RenderStepped:Wait()
			local camCF = camera.CFrame
			
			-- Calculate Movement Vector
			local move = Vector3.new(0,0,0)
			move = move + (camCF.LookVector * (controls.W - controls.S)) -- Forward/Back
			move = move + (camCF.RightVector * (controls.D - controls.A)) -- Left/Right
			move = move + (Vector3.new(0,1,0) * (controls.E - controls.Q)) -- Up/Down
			
			-- Apply Smooth Movement
			bv.Velocity = bv.Velocity:Lerp(move, dt * FLIGHT_ACCEL)
			bg.CFrame = camCF
		end
		stopFlying() -- Stop if loop breaks (death/health<=0)
	end)
end

-- // 4. WALKSPEED FUNCTIONS // --

local function applySpeed()
	local char = player.Character
	if char then
		local hum = char:FindFirstChild("Humanoid")
		if hum then
			hum.WalkSpeed = currentSpeed
		end
	end
end

SetSpeedBtn.MouseButton1Click:Connect(function()
	local amount = tonumber(SpeedInput.Text)
	if amount then
		-- Restriction Logic: Keep between 16 and 100
		if amount < 16 then amount = 16 end
		if amount > 100 then amount = 100 end
		
		currentSpeed = amount
		SpeedInput.Text = tostring(amount) -- Show corrected number
		applySpeed()
	else
		-- If they typed letters/garbage, reset to current
		SpeedInput.Text = tostring(currentSpeed)
	end
end)

-- // 5. EVENT HANDLERS // --

-- Fly Button Toggle
FlyBtn.MouseButton1Click:Connect(function()
	if flying then
		stopFlying()
	else
		startFlying()
	end
end)

-- Respawn Logic (Re-apply settings when you die and come back)
player.CharacterAdded:Connect(function(char)
	flying = false
	FlyBtn.Text = "FLY MODE: OFF"
	FlyBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
	
	-- Wait for Humanoid to load, then re-apply speed
	char:WaitForChild("Humanoid")
	task.wait(0.1)
	applySpeed()
end)

player.CharacterRemoving:Connect(function()
	stopFlying()
end)
