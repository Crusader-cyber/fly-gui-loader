local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local mouse = player:GetMouse()

-- // CONFIGURATION // --
local FLIGHT_SPEED = 50
local FLIGHT_ACCELERATION = 4

-- // GUI CREATION // --
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FlightGUI"
ScreenGui.ResetOnSpawn = false -- Keep GUI when you die
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local FlyBtn = Instance.new("TextButton")
FlyBtn.Name = "FlyButton"
FlyBtn.Parent = ScreenGui
FlyBtn.BackgroundColor3 = Color3.fromRGB(33, 33, 33)
FlyBtn.BorderSizePixel = 0
FlyBtn.Position = UDim2.new(0, 20, 0.5, -25) -- Left side of screen
FlyBtn.Size = UDim2.new(0, 120, 0, 50)
FlyBtn.Font = Enum.Font.GothamBold
FlyBtn.Text = "FLY: OFF"
FlyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
FlyBtn.TextSize = 20

-- Add rounded corners for looks
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = FlyBtn

-- // FLIGHT LOGIC // --
local flying = false
local bv = nil -- BodyVelocity
local bg = nil -- BodyGyro
local controls = {
	W = 0,
	S = 0,
	A = 0,
	D = 0,
	Q = 0, -- Down
	E = 0  -- Up
}

-- Input Handling (WASD + Q/E)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.W then controls.W = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.S then controls.S = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.A then controls.A = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.D then controls.D = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.E then controls.E = FLIGHT_SPEED end
	if input.KeyCode == Enum.KeyCode.Q then controls.Q = FLIGHT_SPEED end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.KeyCode == Enum.KeyCode.W then controls.W = 0 end
	if input.KeyCode == Enum.KeyCode.S then controls.S = 0 end
	if input.KeyCode == Enum.KeyCode.A then controls.A = 0 end
	if input.KeyCode == Enum.KeyCode.D then controls.D = 0 end
	if input.KeyCode == Enum.KeyCode.E then controls.E = 0 end
	if input.KeyCode == Enum.KeyCode.Q then controls.Q = 0 end
end)

-- Main Flight Loop
local function startFlying()
	local char = player.Character or player.CharacterAdded:Wait()
	local hum = char:WaitForChild("Humanoid")
	local root = char:WaitForChild("HumanoidRootPart")

	-- Create Physics Movers
	bv = Instance.new("BodyVelocity")
	bv.Velocity = Vector3.new(0,0,0)
	bv.MaxForce = Vector3.new(1,1,1) * 1000000 -- Strong enough to lift character
	bv.Parent = root
	
	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.new(1,1,1) * 1000000
	bg.P = 10000
	bg.D = 100
	bg.CFrame = root.CFrame
	bg.Parent = root
	
	-- Disable normal gravity/states
	hum.PlatformStand = true 
	
	-- Visual Update
	FlyBtn.Text = "FLY: ON"
	FlyBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0) -- Green
	
	flying = true
	
	-- The Movement Loop
	task.spawn(function()
		while flying and char and hum.Health > 0 do
			local delta = RunService.RenderStepped:Wait()
			
			-- Calculate direction based on Camera
			local camCFrame = camera.CFrame
			
			-- Combine inputs
			local movement = Vector3.new(0,0,0)
			
			-- Forward/Back (W/S) - Follows camera look direction
			movement = movement + (camCFrame.LookVector * (controls.W - controls.S))
			
			-- Left/Right (A/D) - Follows camera right vector
			movement = movement + (camCFrame.RightVector * (controls.D - controls.A))
			
			-- Up/Down (E/Q) - Vertical relative to world
			movement = movement + (Vector3.new(0,1,0) * (controls.E - controls.Q))
			
			-- Smoothly update velocity
			bv.Velocity = bv.Velocity:Lerp(movement, delta * FLIGHT_ACCELERATION)
			
			-- Rotate character to look where the camera is looking
			bg.CFrame = camCFrame
		end
	end)
end

local function stopFlying()
	flying = false
	
	-- Cleanup Physics
	if bv then bv:Destroy() bv = nil end
	if bg then bg:Destroy() bg = nil end
	
	-- Reset Character State
	local char = player.Character
	if char then
		local hum = char:FindFirstChild("Humanoid")
		if hum then
			hum.PlatformStand = false
		end
	end
	
	-- Visual Update
	FlyBtn.Text = "FLY: OFF"
	FlyBtn.BackgroundColor3 = Color3.fromRGB(33, 33, 33) -- Dark Grey
end

-- Toggle Button Logic
FlyBtn.MouseButton1Click:Connect(function()
	if flying then
		stopFlying()
	else
		startFlying()
	end
end)

-- Handle Reset/Death
player.CharacterRemoving:Connect(function()
	stopFlying()
end)
